<!DOCTYPE html>
<meta name = 'viewport' content = 'width=device-width, initial-scale=1.0'>

<link rel = 'stylesheet' href = '/stylesheets/syntax.css' />
<link rel = 'stylesheet' href = '/stylesheets/base.css' />
<link rel = 'stylesheet' href = '/stylesheets/post_nav.css' />



<title>

 Building my first Telegram bot

</title>



<header>
<h1>Lieu</h1>
<p>Hello World
<hr>
</header>

<nav>
  <ul>
    <li><a href = '/'>home</a></li>
    <li><a href = '/about'>about me</a></li>
    <li><a href = '/projects'>current projects</a></li>
    <li><a href = '/blog'>blog</a></li>
  </ul>
</nav>
<hr>
<link rel = 'stylesheet' href = '/stylesheets/nav.css' />


<div class = 'two_column'>

<div class = 'col_1'>
  <h1>Building my first Telegram bot</h1>
  <div class = "tags">
      <strong>tags:</strong>
       
    </ul>
  </div>
<p>I built my first Telegram bot, Charge Bot. The first commit was 3 days ago (18th
September) but I first started working on it on 27th August. Then I took a three-week
break and resumed working on it on 17th September.</p>

<p>You can check the bot out on Telegram <a href="https://telegram.me/charge_game_bot">here.</a>
The Github repo is <a href="https://github.com/lieuzhenghong/charge-bot/">here.</a></p>

<p>This checked a couple of technical firsts for me:</p>

<ol>
  <li>First Telegram bot</li>
  <li>First time I used Python to write anything substantial</li>
  <li>First deploy on Heroku</li>
  <li>First time using non-ASCII characters and working with UTF-8 encoding</li>
  <li>First time using a linter (pylint)</li>
</ol>

<p>There are also a couple of non-technical firsts:</p>

<ol>
  <li>First time building a multiplayer ‚Äúgame‚Äù</li>
  <li>First time building anything my friends can use</li>
  <li>First time building something for public consumption (apart from a blog)</li>
</ol>

<p>It was also the first time I wrote anything for public consumption.</p>

<p>Overall, I am quite happy with this project. The scope was manageable and it did
not balloon (probably because it was a game and, being a game, the scope is rather
clearly defined; what also helped was the limitations of the Telegram medium). 
At the same time, I was able to incorporate user feedback and suggestions.</p>

<h2 id="how-it-works">How it works</h2>

<p>The Python code to write a Telegram bot is extremely trivial.
It is just a while loop that sends HTTP requests with a long timeout (long
polling). Upon receiving a response, it sends the next request.</p>

<p>There is another way which is push instead of pull (doesn‚Äôt send requests: waits for
Telegram to send updates to you) but it is far more involved and wasn‚Äôt suitable for a
first-time project.</p>

<p>Anyway, here‚Äôs the code:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_updates</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">URL</span> <span class="o">+</span> <span class="s">'getUpdates?offset={0}&amp;timeout={1}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">read_offset</span><span class="p">(),</span> <span class="mi">3600</span><span class="p">)</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="n">handle_updates</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
</code></pre>
</div>

<p>That‚Äôs it. But there was a gotcha: As my background is in Javascript where all responses
are asynchronous, the line <code class="highlighter-rouge">req = requests.get(string)</code> tripped me up. If you were to write
that in Javascript you would get <code class="highlighter-rouge">req == undefined</code> or something like that and thus
<code class="highlighter-rouge">handle_updates(req)</code> would throw an error.</p>

<p>For Python, the synchronous nature of the code means that the assignment operator will
actually stop the evaluation until it returns a proper result. That means no callback is
needed and the code becomes very simple.</p>

<h2 id="snafus">Snafus</h2>

<h3 id="modularisation">Modularisation</h3>

<p>This was something that I had a lot of trouble with, despite Mark‚Äôs best efforts to help me.</p>

<p>My code is divvied up as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>* index.py (should be main.py): is the main file, imports everything
* network.py: sends requests and handles responses
* lobby.py: code that allows players to create and join a game
* game.py: game code
* charge_keyboard.py: the inline keyboard needed for the game
</code></pre>
</div>

<p>I was unable to understand the idea of a function that called another function (also known
as‚Ä¶ a callback function LOL). Here‚Äôs what I had trouble with:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># network.py</span>
<span class="k">def</span> <span class="nf">setPushDataTo</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">callback</span>
    <span class="n">callback</span> <span class="o">=</span> <span class="n">func</span>

<span class="k">def</span> <span class="nf">pushDataToDispatcher</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">callback</span>
    <span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c"># index.py</span>

<span class="kn">import</span> <span class="nn">network</span>

<span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
    <span class="s">"""Initialises the app and sets up all callbacks"""</span>
    <span class="n">network</span><span class="o">.</span><span class="n">setPushDataTo</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dispatcher</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="o">...</span>
</code></pre>
</div>

<p>Basically, this pattern allows a function in one file to call a function in another file,
<em>without importing</em>. The reason why we cannot import is because we don‚Äôt want a two-way
import (index imports network, not the other way round).</p>

<p>But we still need some way for the ‚Äúchild‚Äù to communicate with the ‚Äúparent‚Äù and the way
to do it is by setting the callback function in the ‚Äúchild‚Äù to the parent‚Äôs function.</p>

<p>I am not sure I am explaining it clearly‚Ä¶I‚Äôll come back in a few days to this post
and see.</p>

<h3 id="deploying-on-heroku">Deploying on Heroku</h3>

<p>Heroku was a real pain to set up‚Ä¶the documentation was lacking and I spent two nights‚Äô
worth just trying to figure it out.</p>

<p>The gist of it is that you have to have a <code class="highlighter-rouge">requirements.txt</code> file, a <code class="highlighter-rouge">Procfile</code> and a
<code class="highlighter-rouge">runtime.txt</code> file.</p>

<p>The ‚ÄúGetting Started with Heroku‚Äù tutorial mentioned the first two but not the last one!!</p>

<p>Basically, <code class="highlighter-rouge">requirements.txt</code> is just a list of dependencies‚Ä¶ that‚Äôs quite straightforward
I still don‚Äôt know what <code class="highlighter-rouge">runtime.txt</code> does but I had to put in the line <code class="highlighter-rouge">python-3.5.2</code> in
order for Heroku to deploy my app with Python 3. I needed Python 3 because of it‚Äôs native
Unicode handling.</p>

<p>What I mean by that is: when Python2 receives a response as a string, it doesn‚Äôt actually
use Unicode encoding. In order to get it as Unicode you have to put a <code class="highlighter-rouge">u'</code> in front of it.
Python 3 does this all by itself.</p>

<p>The Procfile is also not straightforward. Basically the Procfile tells Heroku what kind of
dyno your app is (web, worker, something else), what file to run with what program. So
like this:</p>

<p><code class="highlighter-rouge">worker: python index.py --loglevel=info</code></p>

<p>(Weirdly, typing python3 index.py throws some weird error and I don‚Äôt know why and haven‚Äôt
been able to Google)</p>

<h2 id="bad-code">Bad code</h2>

<p>This app was developed very haphazardly, and it shows. I used tons of global variables
because I‚Äôm very bad. Coming from a Javascript background I don‚Äôt know how to use classes,
like, <em>at all</em>. So it‚Äôs good that I‚Äôm learning Python.</p>

<p>I tried refactoring but it was truly a huge pain and I actually had to rollback to the
previous commit because I fucked everything up. üò≠</p>

<h2 id="learning-points-and-future-plans">Learning points and future plans</h2>

<p>I want to make as many bots as I can in the future, because Telegram is by far the most-used
app on my phone. It was extremely smart of the Telegram team to expose this API to developers‚Äì
this has allowed it to eclipse Whatsapp even further.</p>

<p>For my next app, I will definitely try and use the webhooks push method.</p>

<p>Heroku has a free dyno tier so I have <strong>no idea</strong> why I‚Äôm paying 8 dollars a month to DigitalOcean.
I think that I will move my automated transaction tracker over to Heroku as well.</p>

<p>I mentioned the bad code: for my next app I am going to try and write it <strong>right</strong> and I
know everyone says that but I mean it, I‚Äôm going to aim for 0 warnings on pylint!!!</p>

<p>Overall, this was a good learning experience, I had fun. Am pretty psyched to build my
next Telegram bot!</p>

</div>

<div class = 'col_2'>
  <h2> Post list </h2>
<ul>
    
    <li>
      <!--
      <span class = 'post_date'> 31 Mar 17</span>
      <br>
      -->
      <a href = "/2017/03/31/quarterly-report-2017.html">2017 Quarterly Report I</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 27 Dec 16</span>
      <br>
      -->
      <a href = "/2016/12/27/2016-in-review.html">2016</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 26 Dec 16</span>
      <br>
      -->
      <a href = "/2016/12/26/2015-in-review.html">2015</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 6 Dec 16</span>
      <br>
      -->
      <a href = "/2016/12/06/ORD-lo.html">ORD lo</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 28 Oct 16</span>
      <br>
      -->
      <a href = "/2016/10/28/october-in-review.html">October in review; plans for November</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 8 Oct 16</span>
      <br>
      -->
      <a href = "/2016/10/08/an-eventful-saturday.html">An eventful Saturday</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 20 Sep 16</span>
      <br>
      -->
      <a href = "/2016/09/20/building-my-first-telegram-bot.html">Building my first Telegram bot</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 5 Sep 16</span>
      <br>
      -->
      <a href = "/2016/09/05/september.html">September</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 11 Aug 16</span>
      <br>
      -->
      <a href = "/2016/08/11/daily-report.html">Long-overdue update</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 24 Jun 16</span>
      <br>
      -->
      <a href = "/2016/06/24/brexit.html">On Brexit, and the unreasonable effectiveness of demagoguery</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 26 May 16</span>
      <br>
      -->
      <a href = "/2016/05/26/daily-report.html">An update on my life so far</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 11 May 16</span>
      <br>
      -->
      <a href = "/2016/05/11/daily-report.html">Meeting with iDA staff (Oscar, Kiranjit and Eric)</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 10 May 16</span>
      <br>
      -->
      <a href = "/2016/05/10/daily-report.html">Meeting with Mrs Hauw, swimming with Xiao Hui and future plans</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 5 May 16</span>
      <br>
      -->
      <a href = "/2016/05/05/daily-report.html">daily report: I talk about what I've done for the past two weeks</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 24 Apr 16</span>
      <br>
      -->
      <a href = "/2016/04/24/daily-report.html">daily report</a>
    </li>
    
    <li>
      <!--
      <span class = 'post_date'> 23 Apr 16</span>
      <br>
      -->
      <a href = "/2016/04/23/daily-report.html">daily report: my first post</a>
    </li>
    
</ul>
</div>


</div>
